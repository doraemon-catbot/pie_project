# 프로젝트 히스토리: 매대 점유율 분석 시스템 개발 여정

## 요약

> **"57개 브랜드를 한 번에 분류하려다 실패했다. 범위를 좁혀 7개 파이류부터 다시 시작한다."**

---

## 1. 시작: facing-analyzer (초코파이 Facing 카운터)

### 목적
매대 사진에서 **초코파이**의 facing(진열 개수)을 세는 도구

### 구현
- **검출**: DETR ResNet-50 (SKU110K 학습)
- **분류**: MobileNetV3 Small (2클래스: 초코파이/기타)
- **UI**: Gradio 기반 웹 인터페이스

### 결과
- 객체 검출 성능 **양호**
- 초코파이 vs 기타 이진분류 **성공적**
- 이 성공을 바탕으로 전체 브랜드로 확장 시도

---

## 2. 확장 시도: pingu (57개 브랜드 점유율 분석)

### 목적
facing-analyzer의 성공을 바탕으로, **오리온 전체 57개 브랜드**의 매대 점유율을 분석하는 시스템 구축

### 구현
- **검출**: YOLOv5x (SKU110K 학습)
- **분류**: MobileNetV3 Small (57클래스)
- **UI**: FastAPI + 웹 대시보드

### 문제점 발견

#### 문제 1: 검출기 성능 저하
- YOLOv5x가 facing-analyzer의 DETR보다 매대 검출 성능이 떨어짐
- 같은 SKU110K 데이터로 학습했지만, **아키텍처 차이(CNN vs Transformer)**가 성능 차이를 만듦

| 검출기 | 아키텍처 | 성능 |
|--------|----------|------|
| YOLOv5x (pingu) | CNN | 미흡 |
| DETR (facing-analyzer) | Transformer | 양호 |

#### 문제 2: 브랜드 분류 정확도 심각하게 낮음
- 57개 브랜드 분류 시 **엉뚱한 브랜드로 분류하는 경향이 심함**
- 거의 대부분 틀림

#### 문제 3: SKU 수에 따른 클래스 불균형 (핵심 발견)
분석 결과, **SKU(상품 종류)가 많은 브랜드일수록 모델이 해당 브랜드라고 과도하게 확신하는 편향** 발견

**원인 분석:**
```
브랜드 A: SKU 10개 → 학습 이미지 1000장 → loss 1000번 누적
브랜드 B: SKU 1개 → 학습 이미지 100장 → loss 100번 누적
```

모델 입장에서는 브랜드 A를 맞추는 게 loss를 줄이는 데 10배 효율적이므로, 애매하면 "브랜드 A"라고 찍는 게 유리해짐. 이것이 **편향 학습**의 원인.

#### 문제 4: 학습 데이터 절대량 부족
- 57개 브랜드를 제대로 학습시키기에 데이터가 턱없이 부족

### 시도한 해결책

1. **검출기 교체 검토**: YOLOv5x → DETR로 교체 계획
2. **학습 데이터 확보**: crop_Project를 만들어 DETR로 매대사진 276장에서 **51,074장** 개별 상품 이미지 crop
3. **class weight 조정 계획**: SKU 많은 브랜드의 학습 가중치를 낮추는 방안 검토

### 결론: 보류
- 57개 브랜드는 범위가 너무 넓음
- 데이터 불균형 해소에 너무 많은 노력 필요
- **범위를 축소해서 다시 시작하기로 결정**

---

## 3. 새 출발: pie_project (파이류 7개 브랜드)

### 전략 변경
- 57개 전체 브랜드 → **7개 파이류 브랜드**로 범위 축소
- 작은 성공을 먼저 만들고, 점진적으로 확장

### 대상 브랜드 (7개)

| 브랜드 | 학습 이미지 |
|--------|-------------|
| 초코파이 | 248장 |
| 참붕어빵 | 269장 |
| 신카스타드 | 97장 |
| 마켓오 리얼브라우니 | 167장 |
| 케익오뜨 | 220장 |
| 후레쉬베리 | 229장 |
| 쉘위 | 83장 |

**총 1,313장**

### 기대 효과

1. **분류 정확도 향상**: 7개 클래스는 57개보다 훨씬 구분하기 쉬움
2. **클래스 불균형 완화**: 브랜드 수가 적어 불균형 영향 감소
3. **빠른 검증 가능**: 작은 범위에서 먼저 성공 확인
4. **점진적 확장**: 파이류 → 스낵류 → 비스킷류 → 전체

### 구현 계획

- **검출**: DETR ResNet-50 (facing-analyzer에서 검증됨)
- **분류**: MobileNetV3 Small (7클래스)
- **UI**: Gradio 대시보드

---

## 4. 확장 로드맵

```
1단계: 파이류 (7개 브랜드) ← 현재
   ↓
2단계: 스낵류 추가
   ↓
3단계: 비스킷류 추가
   ↓
최종: 전체 카테고리 통합
```

카테고리별로 분류기를 만들고, 나중에 통합하는 방식. 한 번에 57개를 하려다 실패한 교훈을 반영.

---

## 5. 핵심 교훈

### 배운 것

1. **범위의 중요성**: 너무 큰 범위로 시작하면 문제 파악도, 해결도 어려움
2. **클래스 불균형의 위험**: SKU 수 차이가 모델 편향으로 이어짐
3. **아키텍처 선택**: 같은 데이터로 학습해도 DETR가 YOLO보다 매대 검출에 적합
4. **점진적 접근**: 작은 성공 → 확장이 한 번에 큰 것보다 효과적

### 앞으로의 방향

1. 파이류 7개 브랜드로 **높은 정확도** 달성
2. 성공하면 스낵류, 비스킷류로 **점진적 확장**
3. 필요시 **class weight 조정**으로 불균형 해소
4. 최종적으로 **전체 브랜드 통합** 시스템 완성

---

## 6. 프로젝트 현황 (2026-02-03)

| 프로젝트 | 상태 | 비고 |
|----------|------|------|
| facing-analyzer | 완료 | 초코파이 facing 카운터, DETR 검증 |
| pingu | 보류 | 57개 브랜드, 정확도 문제 |
| crop_Project | 완료 | 51,074장 crop 생성 |
| pie_project | 진행중 | 7개 파이류, 학습 중 |

---

## 결론

> **"작게 시작해서 크게 키우자."**

57개 브랜드를 한 번에 분류하려는 욕심을 버리고, 7개 파이류부터 확실하게 만든다.
이 작은 성공이 쌓이면, 결국 전체 브랜드를 커버하는 시스템이 완성될 것이다.
