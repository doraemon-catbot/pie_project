# 프로젝트 히스토리: 매대 점유율 분석 시스템 개발 여정

## 요약

> **"브랜드 단위 분류는 실패했다. 같은 브랜드라도 패키징이 다르면 다른 클래스로 봐야 한다."**

---

## 1. 시작: facing-analyzer (초코파이 Facing 카운터)

### 목적
매대 사진에서 **초코파이**의 facing(진열 개수)을 세는 도구

### 구현
- **검출**: DETR ResNet-50 (SKU110K 학습)
- **분류**: MobileNetV3 Small (2클래스: 초코파이/기타)
- **UI**: Gradio 기반 웹 인터페이스

### 결과
- 객체 검출 성능 **양호**
- 초코파이 vs 기타 이진분류 **성공적**
- 이 성공을 바탕으로 전체 브랜드로 확장 시도

---

## 2. 확장 시도: pingu (57개 브랜드 점유율 분석)

### 목적
facing-analyzer의 성공을 바탕으로, **오리온 전체 57개 브랜드**의 매대 점유율을 분석하는 시스템 구축

### 구현
- **검출**: YOLOv5x (SKU110K 학습)
- **분류**: MobileNetV3 Small (57클래스)
- **UI**: FastAPI + 웹 대시보드

### 문제점 발견

#### 문제 1: 검출기 성능 저하
- YOLOv5x가 facing-analyzer의 DETR보다 매대 검출 성능이 떨어짐
- 같은 SKU110K 데이터로 학습했지만, **아키텍처 차이(CNN vs Transformer)**가 성능 차이를 만듦

| 검출기 | 아키텍처 | 성능 |
|--------|----------|------|
| YOLOv5x (pingu) | CNN | 미흡 |
| DETR (facing-analyzer) | Transformer | 양호 |

#### 문제 2: 브랜드 분류 정확도 심각하게 낮음
- 57개 브랜드 분류 시 **엉뚱한 브랜드로 분류하는 경향이 심함**
- 거의 대부분 틀림

#### 문제 3: SKU 수에 따른 클래스 불균형 (핵심 발견)
분석 결과, **SKU(상품 종류)가 많은 브랜드일수록 모델이 해당 브랜드라고 과도하게 확신하는 편향** 발견

**원인 분석:**
```
브랜드 A: SKU 10개 → 학습 이미지 1000장 → loss 1000번 누적
브랜드 B: SKU 1개 → 학습 이미지 100장 → loss 100번 누적
```

모델 입장에서는 브랜드 A를 맞추는 게 loss를 줄이는 데 10배 효율적이므로, 애매하면 "브랜드 A"라고 찍는 게 유리해짐. 이것이 **편향 학습**의 원인.

#### 문제 4: 학습 데이터 절대량 부족
- 57개 브랜드를 제대로 학습시키기에 데이터가 턱없이 부족

### 시도한 해결책

1. **검출기 교체 검토**: YOLOv5x → DETR로 교체 계획
2. **학습 데이터 확보**: crop_Project를 만들어 DETR로 매대사진 276장에서 **51,074장** 개별 상품 이미지 crop
3. **class weight 조정 계획**: SKU 많은 브랜드의 학습 가중치를 낮추는 방안 검토

### 결론: 보류
- 57개 브랜드는 범위가 너무 넓음
- 데이터 불균형 해소에 너무 많은 노력 필요
- **범위를 축소해서 다시 시작하기로 결정**

---

## 3. 새 출발: pie_project (파이류 7개 브랜드)

### 전략 변경
- 57개 전체 브랜드 → **7개 파이류 브랜드**로 범위 축소
- 작은 성공을 먼저 만들고, 점진적으로 확장

### 대상 브랜드 (7개)

| 브랜드 | 학습 이미지 |
|--------|-------------|
| 초코파이 | 248장 |
| 참붕어빵 | 269장 |
| 신카스타드 | 97장 |
| 마켓오 리얼브라우니 | 167장 |
| 케익오뜨 | 220장 |
| 후레쉬베리 | 229장 |
| 쉘위 | 83장 |

**총 1,313장**

### 학습 결과
- **Validation Accuracy: 98.47%** 달성
- 7개 클래스로 줄이니 학습 자체는 성공적

### 실제 테스트 결과: 새로운 문제 발견

#### 문제 5: 같은 브랜드 내 패키징 다양성 (핵심 발견)

매대 사진으로 테스트했을 때, **파이류가 아닌 상품을 "참붕어빵" 등으로 잘못 분류**하는 현상 발생.

**원인 분석:**
- 같은 브랜드여도 **맛/입수에 따라 패키징이 완전히 다름**
- 예: 초코파이 오리지널 vs 초코파이 바나나 → 색상, 디자인이 전혀 다름
- 모델은 이 다양한 패키징을 전부 "초코파이"라는 하나의 라벨로 학습
- 결과적으로 **모델이 "초코파이"가 어떻게 생겼는지 명확히 학습하지 못함**

**문제의 본질:**
```
학습 데이터:
- 초코파이 오리지널 (갈색 박스) → "초코파이"
- 초코파이 바나나 (노란색 박스) → "초코파이"
- 초코파이 딸기 (분홍색 박스) → "초코파이"

모델 입장: "초코파이는 갈색? 노란색? 분홍색? 뭐지?"
→ 혼란스러운 학습 → 엉뚱한 분류
```

---

## 4. 새로운 방향: 패키징(SKU) 단위 분류

### 깨달음

> **"브랜드가 아니라 패키징이 분류의 기준이 되어야 한다."**

모델은 시각적 특징을 학습한다. 같은 브랜드여도 패키징이 다르면 **시각적으로 다른 클래스**다.

### 변경된 전략

| 기존 | 변경 |
|------|------|
| 브랜드 단위 분류 | **패키징(SKU) 단위 분류** |
| "초코파이" 1개 클래스 | "초코파이 오리지널", "초코파이 바나나" 등 별도 클래스 |
| 7개 브랜드 | 패키징 수만큼 클래스 (더 많아짐) |

### 장점
- 각 클래스가 **일관된 시각적 특징**을 가짐
- 모델이 명확하게 학습 가능
- 분류 후 브랜드로 집계하면 됨 (초코파이 오리지널 + 초코파이 바나나 = 초코파이 총 facing)

### 단점
- 클래스 수 증가 → 더 많은 학습 데이터 필요
- 데이터 수집/라벨링 작업량 증가

---

## 5. 핵심 교훈

### 배운 것

1. **범위의 중요성**: 너무 큰 범위로 시작하면 문제 파악도, 해결도 어려움
2. **클래스 불균형의 위험**: SKU 수 차이가 모델 편향으로 이어짐
3. **아키텍처 선택**: 같은 데이터로 학습해도 DETR가 YOLO보다 매대 검출에 적합
4. **점진적 접근**: 작은 성공 → 확장이 한 번에 큰 것보다 효과적
5. **분류 단위의 중요성**: 브랜드가 아니라 **패키징(SKU)**이 분류의 기준이 되어야 함

### 핵심 통찰

> **"모델은 '브랜드'라는 추상적 개념을 모른다. 모델은 '이미지가 어떻게 생겼는지'만 안다."**

같은 브랜드여도 패키징이 다르면 모델에게는 다른 것이다. 이를 무시하고 브랜드 단위로 학습시키면, 모델은 혼란스러운 데이터로 학습하게 되어 성능이 떨어진다.

---

## 6. 프로젝트 현황 (2026-02-03)

| 프로젝트 | 상태 | 비고 |
|----------|------|------|
| facing-analyzer | 완료 | 초코파이 facing 카운터, DETR 검증 |
| pingu | 보류 | 57개 브랜드, 정확도 문제 |
| crop_Project | 완료 | 51,074장 crop 생성 |
| pie_project | 재검토 필요 | 7개 브랜드 → SKU 단위로 변경 검토 |

---

## 7. 다음 단계

1. **학습 데이터 재분류**: 브랜드가 아닌 **패키징(SKU) 단위**로 폴더 재구성
2. **SKU 단위 분류기 학습**: 패키징별로 별도 클래스로 학습
3. **브랜드 집계 로직 추가**: 분류 결과를 브랜드 단위로 합산하는 후처리 로직

---

## 결론

> **"작게 시작하되, 올바른 단위로 시작하자."**

7개 파이류 브랜드로 범위를 줄인 것은 맞았지만, **분류 단위**가 잘못되었다. 브랜드가 아니라 패키징(SKU)이 분류의 기준이 되어야 한다. 같은 브랜드여도 패키징이 다르면 별도 클래스로 학습해야 모델이 정확하게 분류할 수 있다.
