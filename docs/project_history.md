# 프로젝트 히스토리: 매대 점유율 분석 시스템 개발 여정

## 요약

> **"브랜드 단위 분류는 실패했다. 맛별로 분류하고, 결과는 브랜드로 집계한다."**

---

## 1. 시작: facing-analyzer (초코파이 Facing 카운터)

### 목적
매대 사진에서 **초코파이**의 facing(진열 개수)을 세는 도구

### 구현
- **검출**: DETR ResNet-50 (SKU110K 학습)
- **분류**: MobileNetV3 Small (2클래스: 초코파이/기타)
- **UI**: Gradio 기반 웹 인터페이스

### 결과
- 객체 검출 성능 **양호**
- 초코파이 vs 기타 이진분류 **성공적**
- 이 성공을 바탕으로 전체 브랜드로 확장 시도

---

## 2. 확장 시도: pingu (57개 브랜드 점유율 분석)

### 목적
facing-analyzer의 성공을 바탕으로, **오리온 전체 57개 브랜드**의 매대 점유율을 분석하는 시스템 구축

### 구현
- **검출**: YOLOv5x (SKU110K 학습)
- **분류**: MobileNetV3 Small (57클래스)
- **UI**: FastAPI + 웹 대시보드

### 문제점 발견

#### 문제 1: 검출기 성능 저하
- YOLOv5x가 facing-analyzer의 DETR보다 매대 검출 성능이 떨어짐
- 같은 SKU110K 데이터로 학습했지만, **아키텍처 차이(CNN vs Transformer)**가 성능 차이를 만듦

| 검출기 | 아키텍처 | 성능 |
|--------|----------|------|
| YOLOv5x (pingu) | CNN | 미흡 |
| DETR (facing-analyzer) | Transformer | 양호 |

#### 문제 2: 브랜드 분류 정확도 심각하게 낮음
- 57개 브랜드 분류 시 **엉뚱한 브랜드로 분류하는 경향이 심함**
- 거의 대부분 틀림

#### 문제 3: SKU 수에 따른 클래스 불균형 (핵심 발견)
분석 결과, **SKU(상품 종류)가 많은 브랜드일수록 모델이 해당 브랜드라고 과도하게 확신하는 편향** 발견

**원인 분석:**
```
브랜드 A: SKU 10개 → 학습 이미지 1000장 → loss 1000번 누적
브랜드 B: SKU 1개 → 학습 이미지 100장 → loss 100번 누적
```

모델 입장에서는 브랜드 A를 맞추는 게 loss를 줄이는 데 10배 효율적이므로, 애매하면 "브랜드 A"라고 찍는 게 유리해짐. 이것이 **편향 학습**의 원인.

#### 문제 4: 학습 데이터 절대량 부족
- 57개 브랜드를 제대로 학습시키기에 데이터가 턱없이 부족

### 시도한 해결책

1. **검출기 교체 검토**: YOLOv5x → DETR로 교체 계획
2. **학습 데이터 확보**: crop_Project를 만들어 DETR로 매대사진 276장에서 **51,074장** 개별 상품 이미지 crop
3. **class weight 조정 계획**: SKU 많은 브랜드의 학습 가중치를 낮추는 방안 검토

### 결론: 보류
- 57개 브랜드는 범위가 너무 넓음
- 데이터 불균형 해소에 너무 많은 노력 필요
- **범위를 축소해서 다시 시작하기로 결정**

---

## 3. 새 출발: pie_project (파이류 7개 브랜드)

### 전략 변경
- 57개 전체 브랜드 → **7개 파이류 브랜드**로 범위 축소
- 작은 성공을 먼저 만들고, 점진적으로 확장

### 대상 브랜드 (7개)

| 브랜드 | 학습 이미지 |
|--------|-------------|
| 초코파이 | 248장 |
| 참붕어빵 | 269장 |
| 신카스타드 | 97장 |
| 마켓오 리얼브라우니 | 167장 |
| 케익오뜨 | 220장 |
| 후레쉬베리 | 229장 |
| 쉘위 | 83장 |

**총 1,313장**

### 1차 학습 결과
- **Validation Accuracy: 98.47%** 달성
- 7개 클래스로 줄이니 학습 자체는 성공적

### 실제 테스트 결과: 새로운 문제 발견

#### 문제 5: 같은 브랜드 내 패키징 다양성 (핵심 발견)

매대 사진으로 테스트했을 때, **파이류가 아닌 상품을 "참붕어빵" 등으로 잘못 분류**하는 현상 발생.

**원인 분석:**
- 같은 브랜드여도 **맛에 따라 패키징이 완전히 다름**
- 예: 초코파이 오리지널 vs 초코파이 바나나 → 색상, 디자인이 전혀 다름
- 모델은 이 다양한 패키징을 전부 "초코파이"라는 하나의 라벨로 학습
- 결과적으로 **모델이 "초코파이"가 어떻게 생겼는지 명확히 학습하지 못함**

**추가 발견: 입수 vs 맛**
- **입수 차이** (6개입, 12개입 등): 패키징이 거의 동일 → 모델이 구분 못함 → **같은 클래스로 묶어도 됨**
- **맛 차이** (오리지널, 바나나 등): 패키징이 완전히 다름 → 모델이 혼란 → **별도 클래스로 분리 필요**

**문제의 본질:**
```
학습 데이터:
- 초코파이 오리지널 (갈색 박스) → "초코파이"
- 초코파이 바나나 (노란색 박스) → "초코파이"
- 초코파이 딸기 (분홍색 박스) → "초코파이"

모델 입장: "초코파이는 갈색? 노란색? 분홍색? 뭐지?"
→ 혼란스러운 학습 → 엉뚱한 분류
```

---

## 4. 개선: 맛 단위 분류 + 브랜드 집계

### 깨달음

> **"맛별로 분류하고, 결과는 브랜드로 집계한다."**

모델은 시각적 특징을 학습한다. 같은 브랜드여도 맛이 다르면 **시각적으로 다른 클래스**다.
하지만 최종 결과는 브랜드 단위로 보고 싶다.

### 해결책: 2단계 구조

```
[학습] 맛 단위 분류 (시각적으로 구분 가능한 단위)
   ↓
[집계] 브랜드 단위 합산 (비즈니스 관점의 단위)
```

### 폴더 구조 규칙

```
data/train/
├── 브랜드명/
│   ├── 브랜드명_맛1/
│   │   └── 이미지들...
│   └── 브랜드명_맛2/
│       └── 이미지들...
```

**명명 규칙**: `브랜드명_맛` (예: `후레쉬베리_복숭아`)
- `_` 앞: 브랜드명 (집계 시 사용)
- `_` 뒤: 맛 (분류 시 사용)

### 2차 학습: 맛 단위 분류기

**데이터 재분류 완료:**

| 브랜드 | 맛 | 이미지 수 |
|--------|-----|----------|
| 마켓오리얼브라우니 | 기본 | 77장 |
| 마켓오리얼브라우니 | 기본바이트 | 27장 |
| 마켓오리얼브라우니 | 말차 | 57장 |
| 마켓오리얼브라우니 | 말차바이트 | 22장 |
| 마켓오리얼브라우니 | 치즈 | 32장 |
| 쉘위 | 카카오 | 25장 |
| 쉘위 | 클래식 | 40장 |
| 신카스타드 | 기본 | 91장 |
| 참붕어빵 | 기본 | 96장 |
| 참붕어빵 | 슈크림 | 43장 |
| 참붕어빵 | 호떡 | 87장 |
| 초코파이 | 바나나 | 62장 |
| 초코파이 | 수박 | 33장 |
| 초코파이 | 정 | 96장 |
| 케익오뜨 | 쇼콜라 | 105장 |
| 케익오뜨 | 애플파이 | 48장 |
| 케익오뜨 | 치즈 | 56장 |
| 후레쉬베리 | 기본 | 237장 |
| 후레쉬베리 | 멜론 | 22장 |
| 후레쉬베리 | 복숭아 | 58장 |
| 후레쉬베리 | 요거트베리 | 57장 |

**총 21개 맛 클래스, 1,471장** (기존 7개 브랜드 → 21개 맛으로 세분화)

### 대시보드 집계 로직

분류 결과를 브랜드 단위로 합산:

```python
# 예: 분류 결과
"후레쉬베리_복숭아": 3개
"후레쉬베리_멜론": 2개
"후레쉬베리_기본": 5개

# 브랜드 집계 (언더바 앞부분으로 추출)
"후레쉬베리": 10개 (3+2+5)
```

---

## 5. 핵심 교훈

### 배운 것

1. **범위의 중요성**: 너무 큰 범위로 시작하면 문제 파악도, 해결도 어려움
2. **클래스 불균형의 위험**: SKU 수 차이가 모델 편향으로 이어짐
3. **아키텍처 선택**: 같은 데이터로 학습해도 DETR가 YOLO보다 매대 검출에 적합
4. **점진적 접근**: 작은 성공 → 확장이 한 번에 큰 것보다 효과적
5. **분류 단위의 중요성**: 브랜드가 아니라 **맛(시각적으로 구분 가능한 단위)**이 분류의 기준이 되어야 함
6. **입수 vs 맛**: 입수가 달라도 패키징이 같으면 같은 클래스, 맛이 다르면 패키징도 다르므로 별도 클래스

### 핵심 통찰

> **"모델은 '브랜드'라는 추상적 개념을 모른다. 모델은 '이미지가 어떻게 생겼는지'만 안다."**

같은 브랜드여도 맛이 다르면 패키징이 다르고, 모델에게는 다른 것이다.
이를 무시하고 브랜드 단위로 학습시키면, 모델은 혼란스러운 데이터로 학습하게 되어 성능이 떨어진다.

**해결책**:
- **학습은 맛 단위** (시각적으로 일관된 클래스)
- **결과는 브랜드 단위** (비즈니스 관점의 집계)

---

## 6. 2차 학습 결과 (맛 단위 분류기)

### 학습 결과
- **Validation Accuracy: 99.64%** 달성 (기존 브랜드 단위 98.47% 대비 향상)
- 21개 맛 클래스로 세분화하여 시각적 일관성 확보

### 대시보드 개선

#### 1. 면적 기반 점유율 추가
기존 Facing(개수) 기반 점유율에 더해, **면적 기반 점유율**도 함께 표시하도록 개선.

```
- 초코파이: 10개 (Facing 33.3% / 면적 35.2%)
- 후레쉬베리: 8개 (Facing 26.7% / 면적 24.1%)
```

#### 2. 브랜드명 표시
검출된 박스 옆에 **브랜드명과 맛**을 표시하도록 개선.
- 표시 형식: `브랜드 (맛)` (예: `후레쉬베리 (복숭아)`)
- 각 브랜드별 지정 색상으로 박스 및 라벨 표시

---

## 7. 문제 발견: 중첩 박스 (Nested Boxes)

### 문제
매대 사진 분석 시, **박스 안에 박스가 검출**되어 같은 상품이 중복 카운트되는 현상 발생.

### 원인
DETR 검출기가 하나의 상품에 대해 여러 크기의 박스를 제안하는 경우가 있음. 기존 NMS(Non-Maximum Suppression)만으로는 완전히 포함된 박스를 걸러내지 못함.

### 해결책: Nested Box Suppression 추가

`detection.py`에 `_remove_nested_boxes()` 함수 추가:

```python
def _remove_nested_boxes(self, detections, containment_threshold=0.7):
    """
    한 박스가 다른 박스 안에 70% 이상 포함되면 제거
    """
    # 두 박스의 교차 영역 계산
    # 작은 박스의 면적 대비 교차 영역 비율이 threshold 이상이면
    # 작은 박스를 제거
```

**로직:**
1. 모든 박스 쌍에 대해 교차 영역(intersection) 계산
2. 작은 박스의 면적 대비 교차 영역 비율(containment ratio) 계산
3. 비율이 70% 이상이면 작은 박스가 큰 박스 안에 포함된 것으로 판단
4. 포함된 작은 박스 제거

---

## 8. 프로젝트 현황 (2026-02-04)

| 프로젝트 | 상태 | 비고 |
|----------|------|------|
| facing-analyzer | 완료 | 초코파이 facing 카운터, DETR 검증 |
| pingu | 보류 | 57개 브랜드, 정확도 문제 |
| crop_Project | 완료 | 51,074장 crop 생성 |
| pie_project | **진행중** | 48개 맛 분류기, 97.49% 정확도 (3사 통합) |

---

## 9. 완료된 작업

1. ~~학습 데이터 재분류~~: 브랜드가 아닌 **맛 단위**로 폴더 재구성 ✅
2. ~~맛 단위 분류기 학습~~: 21개 맛 클래스로 학습 → **99.64% 정확도** ✅
3. ~~대시보드 수정~~: 분류 결과를 브랜드 단위로 집계하는 로직 추가 ✅
4. ~~면적 기반 점유율~~: Facing + 면적 점유율 동시 표시 ✅
5. ~~브랜드명 표시~~: 박스 옆에 브랜드(맛) 표시 ✅
6. ~~중첩 박스 제거~~: Nested Box Suppression 로직 추가 ✅

---

## 10. 다음 단계 (향후)

1. **실제 매대 테스트**: 다양한 매대 사진으로 정확도 검증
2. **오분류 분석**: 어떤 경우에 오분류가 발생하는지 파악
3. **범위 확장**: 파이류 외 다른 카테고리로 확장 검토

---

## 결론

> **"학습은 시각적 단위로, 결과는 비즈니스 단위로."**

7개 파이류 브랜드로 범위를 줄인 것은 맞았지만, **분류 단위**가 잘못되었다.
맛이 다르면 패키징도 다르므로 별도 클래스로 학습해야 모델이 정확하게 분류할 수 있다.
최종 결과는 브랜드 단위로 집계하여 비즈니스 관점의 인사이트를 제공한다.

### 핵심 개선사항
| 항목 | Before | After |
|------|--------|-------|
| 분류 단위 | 7개 브랜드 | 21개 맛 |
| 검증 정확도 | 98.47% | **99.64%** |
| 점유율 표시 | Facing만 | Facing + 면적 |
| 박스 표시 | 색상만 | 색상 + 브랜드(맛) |
| 중복 검출 | 박스 안 박스 발생 | Nested Box Suppression |

---

## 11. 2026-02-04 업데이트: 경쟁사 통합 및 UI 개선

### 11.1 경쟁사 브랜드 추가 (3사 통합)

기존 오리온 9개 브랜드에서 **롯데, 해태크라운** 브랜드를 추가하여 총 48개 맛 클래스로 확장.

| 회사 | 브랜드 수 | 맛(클래스) 수 |
|------|----------|--------------|
| 오리온 | 9개 | 24개 |
| 롯데 | 5개 | 14개 |
| 해태크라운 | 3개 | 10개 |
| **합계** | **17개** | **48개** |

**학습 결과:**
- 총 이미지: 2,590장
- 학습/검증: 2,072장 / 517장
- **Validation Accuracy: 97.49%**

### 11.2 브랜드 추출 버그 수정

**문제:** "ZERO 초콜릿칩쿠키"가 ZERO 브랜드로 묶이지 않음

**원인:** `extract_brand()` 함수가 언더바(`_`)만 인식, 공백(` `) 미인식

**해결:**
```python
def extract_brand(flavor_name: str) -> str:
    if "_" in flavor_name:
        return flavor_name.split("_")[0]
    if " " in flavor_name:  # 추가
        return flavor_name.split(" ")[0]
    return flavor_name
```

### 11.3 UI 전면 개선

**변경 전:** 마크다운 테이블, 단순 파이차트

**변경 후:**
- **회사별 점유율 컬러 바**: 직관적 시각화
  - 오리온: 빨강 (#DC2626)
  - 롯데: 상아색 (#D4A574)
  - 해태크라운: 초록 (#16A34A)
- **브랜드별 테이블**: 행/열 전환 (브랜드가 열, 지표가 행)
- **숫자 카드**: 전체 검출/파이류 수량 강조 표시
- **Soft 테마** 적용 (오렌지 계열)

### 11.4 쉘위 박스 크기 보정

**문제:** 쉘위 제품의 검출 박스가 실제보다 작음 (왼쪽 약 20% 누락)

**영향:** 면적 점유율 계산 시 쉘위(오리온) 비율이 실제보다 낮게 산출

**해결:** 분류 후 쉘위로 판별된 박스만 왼쪽으로 20% 확장
```python
if det["brand"] == "쉘위":
    x1 = max(0, x1 - box_w * 0.20)  # 왼쪽만 확장
```

### 11.5 미분류 제품 점유율 포함

**변경 전:** 미분류 제품은 점유율 계산에서 제외됨

**문제:** 미학습 제품이 많으면 오리온/롯데/해태 점유율이 과대 산출

**변경 후:** 미분류 제품도 "기타" 회사로 점유율에 포함
```python
# Before
pie_detections = [d for d in detections if d.get("flavor") != "미분류"]

# After
pie_detections = detections  # 미분류도 "기타"로 포함
```

### 11.6 향후 계획: 기타 폴더 추가

타사 제품을 "기타"로 정확하게 학습시키기 위해 폴더 구조 확장 예정:
```
data/train/파이/
├── 오리온/
├── 롯데/
├── 해태크라운/
└── 기타/           ← 추가 예정
    ├── 기타_농심제품/
    └── ...
```

---

## 12. 2026-02-04 작업 리포트

### 작업 일자
2026년 2월 4일

### 완료 항목

| # | 작업 내용 | 상태 |
|---|----------|------|
| 1 | "ZERO 초콜릿칩쿠키" 브랜드 추출 버그 수정 | ✅ |
| 2 | UI 개선 - 컬러 바 기반 회사별 점유율 표시 | ✅ |
| 3 | UI 개선 - 브랜드 테이블 행/열 전환 | ✅ |
| 4 | 회사별 색상 지정 (오리온:빨강, 롯데:상아, 해태:초록) | ✅ |
| 5 | 쉘위 박스 왼쪽 20% 확장 (면적 보정) | ✅ |
| 6 | 미분류 제품 "기타" 회사로 점유율 포함 | ✅ |

### 기술적 변경사항

| 파일 | 변경 내용 |
|------|----------|
| `app/analysis.py` | `extract_brand()` 공백 구분 추가, 미분류 포함 |
| `app/main.py` | UI 전면 개선, 쉘위 박스 확장 로직, HTML 결과 표시 |
| `app/detection.py` | 변경 없음 (박스 확장은 main.py에서 처리) |

### 남은 과제

1. **기타 폴더 생성 및 학습**: 타사 제품 데이터 수집
2. **스낵 카테고리 확장**: 파이 외 스낵류 추가 계획
3. **실사용 테스트**: 다양한 매대 사진으로 정확도 검증
